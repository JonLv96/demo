# LiteFlowçƒ­åŠ è½½å®ç°æœºåˆ¶æ·±åº¦æ€»ç»“

## ğŸ” LiteFlowçƒ­åŠ è½½æ ¸å¿ƒå®ç°é€»è¾‘

LiteFlowä½œä¸ºä¸€æ¬¾ä¼˜ç§€çš„æµç¨‹ç¼–æ’å¼•æ“ï¼Œå…¶çƒ­åŠ è½½æœºåˆ¶è®¾è®¡ç²¾å¦™ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶å’Œå®ç°é€»è¾‘ï¼š

### ğŸ“‹ æ ¸å¿ƒæ¶æ„å±‚æ¬¡

#### 1. **é…ç½®ç›‘å¬å±‚** (Configuration Monitoring Layer)
- **æ ¸å¿ƒç±»**: `FlowConfigurationWatcher`
- **åŠŸèƒ½**: ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œè§¦å‘é‡è½½æµç¨‹
- **å®ç°æœºåˆ¶**:
  - ä½¿ç”¨Java NIOçš„`WatchService`ç›‘å¬æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶
  - æ”¯æŒXMLã€JSONã€YAMLç­‰å¤šç§é…ç½®æ ¼å¼
  - å®ç°é…ç½®æ–‡ä»¶å˜æ›´çš„å®æ—¶æ£€æµ‹å’Œé€šçŸ¥

#### 2. **è§„åˆ™è§£æå±‚** (Rule Parsing Layer)
- **æ ¸å¿ƒç±»**: `FlowParser`ã€`FlowBus`
- **åŠŸèƒ½**: è§£ææµç¨‹å®šä¹‰ï¼Œç®¡ç†æµç¨‹ç¼“å­˜
- **å®ç°æœºåˆ¶**:
  - è§£æé…ç½®æ–‡ä»¶æ„å»ºæµç¨‹å®šä¹‰å¯¹è±¡
  - ä½¿ç”¨`FlowBus`ä½œä¸ºå…¨å±€æµç¨‹ç¼“å­˜ä¸­å¿ƒ
  - æ”¯æŒå¤æ‚è¡¨è¾¾å¼è§£æï¼ˆTHENã€WHENã€IFç­‰ï¼‰

#### 3. **èŠ‚ç‚¹ç®¡ç†å±‚** (Node Management Layer)
- **æ ¸å¿ƒç±»**: `NodeComponent`ã€`NodeCmpFactory`
- **åŠŸèƒ½**: ç®¡ç†èŠ‚ç‚¹ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
- **å®ç°æœºåˆ¶**:
  - èŠ‚ç‚¹ç»„ä»¶çš„åŠ¨æ€æ³¨å†Œå’Œæ³¨é”€
  - ä¸Springå®¹å™¨æ·±åº¦é›†æˆï¼Œæ”¯æŒä¾èµ–æ³¨å…¥
  - èŠ‚ç‚¹å®ä¾‹çš„ç¼“å­˜å’Œå¤ç”¨

#### 4. **ç±»åŠ è½½å±‚** (Class Loading Layer)
- **æ ¸å¿ƒç±»**: `LiteFlowClassLoader`
- **åŠŸèƒ½**: æ”¯æŒèŠ‚ç‚¹ç±»çš„çƒ­åŠ è½½
- **å®ç°æœºåˆ¶**:
  - è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œæ‰“ç ´åŒäº²å§”æ´¾
  - èŠ‚ç‚¹ç±»çš„ç‰ˆæœ¬ç®¡ç†å’Œéš”ç¦»
  - é˜²æ­¢å†…å­˜æ³„æ¼çš„ç±»å¸è½½æœºåˆ¶

#### 5. **æ‰§è¡Œå¼•æ“å±‚** (Execution Engine Layer)
- **æ ¸å¿ƒç±»**: `LiteflowExecutor`ã€`Chain`
- **åŠŸèƒ½**: æµç¨‹æ‰§è¡Œç¼–æ’å’Œé“¾å¼è°ƒç”¨
- **å®ç°æœºåˆ¶**:
  - æ‰§è¡Œé“¾çš„åŠ¨æ€æ„å»ºå’Œä¼˜åŒ–
  - æ”¯æŒåŒæ­¥ã€å¼‚æ­¥æ‰§è¡Œæ¨¡å¼
  - å¼‚å¸¸å¤„ç†å’Œæµç¨‹æ§åˆ¶

#### 6. **Springé›†æˆå±‚** (Spring Integration Layer)
- **æ ¸å¿ƒç±»**: `LiteFlowAutoConfiguration`ã€`LiteFlowConfig`
- **åŠŸèƒ½**: ä¸Springç”Ÿæ€æ— ç¼é›†æˆ
- **å®ç°æœºåˆ¶**:
  - Spring Bootè‡ªåŠ¨è£…é…
  - é…ç½®å±æ€§åŠ¨æ€ç»‘å®š
  - Beanç”Ÿå‘½å‘¨æœŸç®¡ç†

## ğŸ”„ å®Œæ•´çƒ­åŠ è½½æµç¨‹

```mermaid
graph TD
    A[é…ç½®æ–‡ä»¶ä¿®æ”¹] --> B[æ–‡ä»¶ç›‘å¬å™¨æ£€æµ‹å˜åŒ–]
    B --> C[è§¦å‘é…ç½®é‡è½½äº‹ä»¶]
    C --> D[è§£ææ–°é…ç½®æ–‡ä»¶]
    D --> E[éªŒè¯é…ç½®è¯­æ³•]
    E --> F[æ›´æ–°æµç¨‹ç¼“å­˜]
    F --> G[é‡æ–°æ³¨å†ŒèŠ‚ç‚¹ç»„ä»¶]
    G --> H[é‡å»ºæ‰§è¡Œé“¾]
    H --> I[çƒ­æ›´æ–°ç”Ÿæ•ˆ]
    I --> J[æ–°è¯·æ±‚ä½¿ç”¨æ–°é…ç½®]
```

## ğŸ’¡ å…³é”®æŠ€æœ¯å®ç°

### 1. **é…ç½®æ–‡ä»¶ç›‘å¬**

```java
// æ ¸å¿ƒç›‘å¬é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
WatchService watchService = FileSystems.getDefault().newWatchService();
Path configDir = Paths.get(configPath).getParent();
configDir.register(watchService, StandardWatchEventKinds.ENTRY_MODIFY);

while (isWatching) {
    WatchKey key = watchService.take();
    for (WatchEvent<?> event : key.pollEvents()) {
        if (event.kind() == StandardWatchEventKinds.ENTRY_MODIFY) {
            // è§¦å‘é…ç½®é‡è½½
            reloadConfiguration();
        }
    }
    key.reset();
}
```

### 2. **æµç¨‹å®šä¹‰è§£æ**

```java
// LiteFlowé…ç½®è§£æç¤ºä¾‹
public class FlowParser {
    public Chain parseChain(Element chainElement) {
        String chainName = chainElement.attributeValue("name");
        Chain chain = new Chain(chainName);

        // è§£ææµç¨‹è¡¨è¾¾å¼
        String expression = chainElement.element("THEN").attributeValue("value");
        List<Node> nodes = parseExpression(expression);

        // æ„å»ºæ‰§è¡Œé“¾
        chain.setChain(nodes);
        return chain;
    }
}
```

### 3. **èŠ‚ç‚¹åŠ¨æ€æ³¨å†Œ**

```java
// èŠ‚ç‚¹ç»„ä»¶åŠ¨æ€æ³¨å†Œ
public void registerNode(String nodeId, Class<?> nodeClass) {
    try {
        // ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨
        ClassLoader loader = new LiteFlowClassLoader(classPath);
        Class<?> loadedClass = loader.loadClass(nodeClass.getName());

        // åˆ›å»ºèŠ‚ç‚¹å®ä¾‹
        NodeComponent node = (NodeComponent) loadedClass.newInstance();

        // Springä¾èµ–æ³¨å…¥
        applicationContext.getAutowireCapableBeanFactory()
            .autowireBean(node);

        // æ³¨å†Œåˆ°èŠ‚ç‚¹ç®¡ç†å™¨
        nodeManager.registerNode(nodeId, node);

    } catch (Exception e) {
        throw new RuntimeException("èŠ‚ç‚¹æ³¨å†Œå¤±è´¥", e);
    }
}
```

### 4. **æ‰§è¡Œé“¾é‡å»º**

```java
// æ‰§è¡Œé“¾åŠ¨æ€é‡å»º
public void rebuildChain(Chain chain) {
    // æ¸…ç†æ—§æ‰§è¡Œé“¾
    chain.clear();

    // æ ¹æ®æœ€æ–°é…ç½®é‡æ–°æ„å»º
    for (String nodeId : chain.getNodeIds()) {
        NodeComponent node = nodeManager.getNode(nodeId);
        if (node != null) {
            chain.addNode(node);
        }
    }

    // éªŒè¯é“¾å®Œæ•´æ€§
    chain.validate();
}
```

## ğŸ¯ LiteFlowçƒ­åŠ è½½çš„æ ¸å¿ƒä¼˜åŠ¿

### 1. **æ— ä¾µå…¥æ€§**
- ä¸éœ€è¦é‡å¯åº”ç”¨
- ä¸å½±å“æ­£åœ¨æ‰§è¡Œçš„æµç¨‹
- å¯¹ä¸šåŠ¡ä»£ç é›¶ä¾µå…¥

### 2. **é«˜æ€§èƒ½**
- å¢é‡æ›´æ–°æœºåˆ¶
- æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- å¼‚æ­¥å¤„ç†æµç¨‹

### 3. **é«˜å¯é æ€§**
- é…ç½®éªŒè¯æœºåˆ¶
- å¼‚å¸¸éš”ç¦»å¤„ç†
- å›æ»šæ”¯æŒ

### 4. **å¤šæ ¼å¼æ”¯æŒ**
- XMLé…ç½®æ–‡ä»¶
- JSONé…ç½®æ–‡ä»¶
- YAMLé…ç½®æ–‡ä»¶
- æ³¨è§£é…ç½®

### 5. **æ·±åº¦é›†æˆ**
- Springç”Ÿæ€é›†æˆ
- å¤šç§è„šæœ¬å¼•æ“
- ç›‘æ§ç³»ç»Ÿé›†æˆ

## ğŸ”§ å®é™…åº”ç”¨åœºæ™¯

### 1. **ä¸šåŠ¡è§„åˆ™å¼•æ“**
- å¤æ‚ä¸šåŠ¡æµç¨‹ç¼–æ’
- åŠ¨æ€è§„åˆ™é…ç½®
- å®æ—¶æµç¨‹è°ƒæ•´

### 2. **APIç¼–æ’**
- å¾®æœåŠ¡èšåˆ
- æ•°æ®è½¬æ¢æµæ°´çº¿
- æœåŠ¡ç¼–æ’æ²»ç†

### 3. **æ•°æ®å¤„ç†æµæ°´çº¿**
- ETLæµç¨‹ç¼–æ’
- å®æ—¶æ•°æ®å¤„ç†
- æ‰¹å¤„ç†ä»»åŠ¡è°ƒåº¦

### 4. **å·¥ä½œæµå¼•æ“**
- å®¡æ‰¹æµç¨‹
- ä¸šåŠ¡æµç¨‹ç®¡ç†
- çŠ¶æ€æœºå®ç°

## ğŸ“š ä¸æœ¬Demoçš„å¯¹æ¯”

| ç‰¹æ€§ | LiteFlowå®˜æ–¹ | æœ¬Demoå®ç° |
|------|-------------|------------|
| é…ç½®ç›‘å¬ | âœ… å®Œæ•´å®ç° | âœ… ç®€åŒ–å®ç° |
| æµç¨‹è§£æ | âœ… æ”¯æŒå¤æ‚è¡¨è¾¾å¼ | âš¡ åŸºç¡€è§£æ |
| èŠ‚ç‚¹ç®¡ç† | âœ… å®Œæ•´ç”Ÿå‘½å‘¨æœŸ | âš¡ åŸºç¡€æ³¨å†Œ |
| ç±»åŠ è½½ | âœ… ä¼ä¸šçº§å®ç° | âœ… æ ¸å¿ƒåŸç† |
| Springé›†æˆ | âœ… æ·±åº¦é›†æˆ | âŒ æœªå®ç° |
| è„šæœ¬æ”¯æŒ | âœ… å¤šè„šæœ¬å¼•æ“ | âŒ æœªå®ç° |
| ç›‘æ§é›†æˆ | âœ… å®Œæ•´ç›‘æ§ | âŒ æœªå®ç° |

## ğŸš€ å­¦ä¹ ä»·å€¼

é€šè¿‡æœ¬Demoï¼Œä½ å¯ä»¥æ·±å…¥ç†è§£ï¼š

1. **çƒ­åŠ è½½çš„æ ¸å¿ƒåŸç†** - é…ç½®ç›‘å¬ã€ç¼“å­˜æ›´æ–°ã€ç±»åŠ è½½
2. **æµç¨‹ç¼–æ’çš„è®¾è®¡æ€æƒ³** - èŠ‚ç‚¹ã€é“¾ã€è¡¨è¾¾å¼çš„æŠ½è±¡
3. **ä¼ä¸šçº§æ¡†æ¶çš„æ¶æ„è®¾è®¡** - åˆ†å±‚ã€è§£è€¦ã€æ‰©å±•æ€§
4. **å®é™…ç”Ÿäº§ç¯å¢ƒçš„è€ƒé‡** - æ€§èƒ½ã€ç¨³å®šæ€§ã€æ˜“ç”¨æ€§

è¿™ä¸ªDemoä¸ºä½ æä¾›äº†ä¸€ä¸ªå­¦ä¹ LiteFlowçƒ­åŠ è½½æœºåˆ¶çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œå¸®åŠ©ä½ ç†è§£å…¶æ ¸å¿ƒè®¾è®¡æ€æƒ³å’Œå®ç°åŸç†ï¼Œä¸ºè¿›ä¸€æ­¥å­¦ä¹ å’Œä½¿ç”¨LiteFlowæ‰“ä¸‹åšå®åŸºç¡€ã€‚